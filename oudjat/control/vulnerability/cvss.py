"""
A module that describe the notion of CVSS.
"""

from typing import Any, override

from oudjat.utils import Context

from ..vulnerability.severity import Severity


class CVSS:
    """A class to describe CVSS metric."""

    # ****************************************************************
    # Attributes & Constructors

    def __init__(
        self,
        score: float = 0,
        version: float = 4.0,
    ) -> None:
        """
        Create a new instance of CVE.

        Args:
            score (float)  : CVSS score (0-10)
            version (float): the CVSS metric version
        """

        self._score: float = score
        self._version: float = version
        self._severity: "Severity"

        self.resolve_severity()

    # ****************************************************************
    # Methods

    @property
    def score(self) -> float:
        """
        Return the CVSS score.

        Returns:
            float : CVE CVSS score
        """

        return self._score

    @score.setter
    def score(self, new_score: float) -> None:
        """
        Set the vulnerability CVSS score.

        Args:
            new_score (float) : new CVSS score
        """

        if CVSS.check_score(new_score):
            self._score = new_score
            self.resolve_severity()

        else:
            raise ValueError(
                f"{Context()}::{new_score} is not a valid CVSS score. You must provide a value between 0 and 10"
            )

    @property
    def version(self) -> float:
        """
        Return the CVSS version.

        Returns:
            float: the CVSS version (3.0, 4.0, etc.)
        """

        return self._version

    @property
    def severity(self) -> "Severity":
        """
        Return the severity.

        Returns:
            Severity: the severity associated with the current CVSS
        """

        return self._severity

    def resolve_severity(self) -> None:
        """Resolve the severity based on the CVSS score."""

        self._severity = Severity.from_cvss(self._score)

    @override
    def __str__(self) -> str:
        """
        Return the current CVSS as a string.

        Returns:
            str: a string representation of the current CVSS
        """

        return f"{self.score} ({self.severity})"

    def __float__(self) -> float:
        """
        Return the current CVSS as a float.

        Returns:
            float: the score of the current CVSS
        """

        return self.score

    def to_dict(self) -> dict[str, Any]:
        """
        Convert the current CVSS into a dictionary.

        Returns:
            dict[str, Any]: A dictionary representation of the current CVSS
        """

        return {"score": self.score, "severity": self.severity, "version": self.version}

    # ****************************************************************
    # Static methods

    @staticmethod
    def check_score(score: float) -> bool:
        """
        Check whether the given cvss score is valid.

        Args:
            score (float) : CVSS score

        Return:
            bool : whether or not the CVSS score is valid (between 0 and 10)
        """

        return 0 <= score <= 10
